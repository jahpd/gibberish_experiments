<!DOCTYPE html>
<html>
<head>
  <title>Giberails Demo</title>
  <script src="/assets/javascripts/jquery.js"></script>
  <style>
  	#code_coffee_editor{
  		position: absolute;
  		top:0;
  		bottom: 0;
  		left:0;
  		right:0;
  	}
  </style>
</head>
<body>
  <script src="assets/javascripts/gibberish_2.0.js"></script>
  <script src="assets/javascripts/ace.js"></script>
  <script src="assets/javascripts/theme-monokai.js"></script>
  <script src="assets/javascripts/mode-coffee.js"></script>
  <script src="assets/javascripts/worker-coffee.js"></script>
  <script src="assets/javascripts/coffee-script.js"></script>
  <div id="code_coffee_editor"></div>
  <script>

//<![CDATA[
(function() {
  var console, editor;

  console = window.console;

  window.RAILS = {
    initialized: false,
    editor: null,
    clean: function(callback) {
      console.log('Operating cleaning...');
      if (window.RAILS.initialized || false) {
        Gibberish.clear();
      }
      return callback();
    },
    init: function(callback) {
      var e;
      console.log('Initializing Gibberails audio-client...');
      try {
        Gibberish.init();
        Gibberish.Time["export"]();
        Gibberish.Binops["export"]();
        if (callback) {
          return callback();
        }
      } catch (_error) {
        e = _error;
        return alert(e);
      }
    },
    execute: function(compile, data, callback) {
      var e, js;
      try {
        js = unescape(data);
        js = compile(js, {
          bare: true,
          map: {}
        });
        js = unescape(js);
        if (callback) {
          return callback(!js, js);
        }
      } catch (_error) {
        e = _error;
        window.RAILS.initialized = false;
        return alert("" + compile.prototype.name + ":\n" + js.map + e);
      }
    },
    run: function(callback) {
      console.log('Operating compilation...');
      return RAILS.execute(CoffeeScript.compile, RAILS.editor.getValue(), function(err, js) {
        if (callback) {
          return callback(err, eval(js));
        } else {
          return eval(js);
        }
      });
    },
    checkfloats: function(k, v) {
      var b, t, _i, _len, _ref;
      b = false;
      _ref = ['freq', 'amp', 'pulsewidth', 'chance', 'pitchMin', 'pitchMax', 'pitchChance', 'cutoff', 'Q', 'roomSize', 'dry', 'wet'];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        t = _ref[_i];
        if ((typeof v === 'object') && k === t) {
          b = true;
          break;
        }
      }
      return b;
    },
    checkints: function(k, v) {
      var b, t, _i, _len, _ref;
      b = false;
      _ref = ['mode', 'rate', 'amount'];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        t = _ref[_i];
        if ((typeof v === 'object') && k === t) {
          b = true;
          break;
        }
      }
      return b;
    },
    INIT: function(time, callback) {
      return setTimeout(function() {
        return RAILS.clean(function() {
          return RAILS.init(function() {
            console.log("! RUnNINg !");
            RAILS.initialized = true;
            return callback();
          });
        });
      }, time);
    },
    GEN: function(n, o, c) {
      var e, k, u, v;
      try {
        u = new Gibberish[n];
        console.log("" + u + " " + n + ":");
        for (k in o) {
          v = o[k];
          console.log("  " + k + ":" + v);
          u[k] = v;
        }
        if (c) {
          return c(u);
        } else {
          return u;
        }
      } catch (_error) {
        e = _error;
        return alert(e);
      }
    },
    GEN_RAND: function(n, o, c) {
      var k, v;
      for (k in o) {
        v = o[k];
        if (RAILS.checkfloats(k, v)) {
          o[k] = Gibberish.rndf(v[0], v[v.length - 1]);
        } else if (RAILS.checkints(k, v)) {
          o[k] = Gibberish.rndi(v[0], v[v.length - 1]);
        } else {
          o[k] = v;
        }
      }
      return RAILS.GEN(n, o, c);
    },
    GEN_FN: function(n, o, c) {
      var k, v;
      for (k in o) {
        v = o[k];
        if (typeof v === 'Function') {
          o[k] = v();
        }
      }
      return RAILS.GEN(n, o, c);
    },
    GEN_SEQ: function(o, c) {
      var k, u, v, _ref;
      _ref = o.keysAndValues;
      for (k in _ref) {
        v = _ref[k];
        o.keysAndValues[k] = v();
      }
      o.durations = o.durations();
      u = new Gibberish.Sequencer(o);
      if (c) {
        return c(u);
      } else {
        return u;
      }
    }
  };

  RAILS.editor = editor = ace.edit('code_coffee_editor');

  editor.setTheme('ace/theme/monokai');

  editor.getSession().setMode('ace/mode/coffee');

  editor.setValue('RAILS.INIT 100, ->\n  \n  # Create a KarplusStrong instrument with random variables\n  # Gibberish will route all audio for you\n  karplus = RAILS.GEN \"KarplusStrong\", \n    blend: Add 0.9, RAILS.GEN_RAND \"Triangle\", amp:[0.01, 0.1], freq:[0.01, 0.1]\n    damping: Add 0.9, RAILS.GEN_RAND \"Triangle\", amp:[0.01, 0.1], freq:[0.01, 0.1]\n    \n  # An FX\n  # TODO switch to GEN or GEN_RANGE\n  RAILS.GEN_RAND \"Reverb\",\n    input: RAILS.GEN \"Reverb\",\n      input: RAILS.GEN \"BufferShuffler\",\n        input: RAILS.GEN_RAND \"SVF\", {input:karplus, cutoff:[200, 800], Q:[0.1, 4], mode:[0, 3]}\n        chance:.75\n        amount:125\n        rate:44100\n        pitchMin:-4\n        pitchMax:4\n      roomSize: Add 0.85, RAILS.GEN_RAND \"Sine\", amp:[0.4, 0.6], freq:[0.01, 10]\n      wet: Add 0.775, RAILS.GEN_RAND \"Sine\", amp:[0.2, 0.3], freq:[0.01, 10]\n      dry: Add 0.5, RAILS.GEN_RAND \"Sine\", amp:[0.4, 0.6], freq:[0.01, 10]\n    roomSize: [0.8, 1]\n    wet:[0.1, 0.75]\n    dry:[0.25, 0.45]\n  , (rev) -> rev.connect()\n \n # The sequence music\n # TODO switch arrays by functions that return an alghorimth array\n  RAILS.GEN_SEQ(\n    target: karplus\n    keysAndValues:\n      note: ->\n        a = []\n        a[i] = ((i+1)*110) for i in [0..9]\n        a[Gibberish.rndi(0, a.length-1)] for i in [0..20]\n        a\n      amp: ->\n        a = []\n        a[i] = (((i+1)*110)/1100) for i in [0..7]\n        a[Gibberish.rndi(0, a.length-1)] for i in [0..12]\n        a\n    durations: -> \n      a=[]\n      for i in [0..Math.floor(Math.random() * 34)]\n        a[_i]=ms(Math.floor(Math.random() * 2000))\n      a\n  , (seq) -> seq.start())');

  console.log('Ace editor loaded!');

  editor.commands.addCommand({
    name: 'render_code_play',
    bindKeys: {
      win: 'Ctrl-Enter',
      linux: 'Ctrl-Enter',
      mac: 'Command-Enter'
    },
    exec: function(editor) {
      return RAILS.run(function(result) {
        return RAILS.initialized = !!result;
      });
    },
    readOnly: true
  });

  editor.commands.addCommand({
    name: 'stop_code_play',
    bindKeys: {
      win: 'Ctrl-.',
      linux: 'Ctrl-.',
      mac: 'Command-.'
    },
    exec: function(editor) {
      return RAILS.clean();
    },
    readOnly: true
  });

  return RAILS.run();

}).call(this);

//]]>

  </script>
